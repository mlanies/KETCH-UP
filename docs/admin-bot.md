# Админ-бот для Telegram Wine Bot

## Обзор

Админ-бот — это отдельный Telegram-бот для администраторов системы обучения официантов. Он предоставляет инструменты для просмотра аналитики, отзывов пользователей и управления системой.

## Назначение

- **Просмотр отзывов** пользователей после уроков
- **Аналитика обучения** — статистика, прогресс, слабые темы
- **Управление пользователями** (в будущем)
- **Мониторинг системы** обучения

## Архитектура

### Отдельный воркер
- **Файл:** `src/admin-bot.js`
- **Endpoint:** `https://telegram-wine-bot-admin.2gc.workers.dev`
- **Environment:** `admin` в wrangler.toml
- **Токен:** `ADMIN_BOT_TOKEN` (отдельный от основного бота)

### Безопасность
- Доступ ограничен по chat_id администраторов
- Отдельный токен и endpoint
- Изолированная логика от пользовательского бота

## Команды

### `/start`
Приветственное сообщение с списком доступных команд.

### `/feedback`
Просмотр отзывов пользователей (в разработке).

### `/analytics`
Просмотр аналитики обучения (в разработке).

## Настройка

### 1. Создание бота
- Создайте нового бота через @BotFather
- Получите токен для админ-бота

### 2. Установка секретов
```bash
npx wrangler secret put ADMIN_BOT_TOKEN --env admin
```

### 3. Деплой
```bash
npx wrangler deploy --env admin
```

### 4. Установка webhook
```bash
curl "https://api.telegram.org/bot<ADMIN_BOT_TOKEN>/setWebhook?url=https://telegram-wine-bot-admin.2gc.workers.dev"
```

### 5. Проверка webhook
```bash
curl "https://api.telegram.org/bot<ADMIN_BOT_TOKEN>/getWebhookInfo"
```

## Конфигурация wrangler.toml

```toml
[env.admin]
name = "telegram-wine-bot-admin"
main = "src/admin-bot.js"
compatibility_date = "2024-01-01"

[env.admin.triggers]
routes = [
  "https://wine-admin.2gc.ru/*"
]
```

## Логирование

Админ-бот включает подробное логирование:
- Входящие обновления от Telegram
- Обработка команд
- Ответы Telegram API
- Ошибки отправки сообщений

### Просмотр логов
```bash
npx wrangler tail telegram-wine-bot-admin
```

## Ограничение доступа

### Временное решение
Проверка chat_id временно отключена для тестирования.

### Постоянное решение
```javascript
const ADMIN_IDS = [194832010]; // chat_id администраторов
if (!ADMIN_IDS.includes(chatId)) {
  await sendMessage(chatId, '⛔️ Нет доступа', env);
  return;
}
```

## Будущие улучшения

- [ ] Реализация просмотра отзывов пользователей
- [ ] Детальная аналитика обучения
- [ ] Управление пользователями
- [ ] Экспорт данных
- [ ] Рассылка сообщений всем пользователям
- [ ] Модерация контента

## Устранение неполадок

### Бот не отвечает
1. Проверьте, что webhook установлен правильно
2. Проверьте логи через `wrangler tail`
3. Убедитесь, что токен корректный

### Ошибка 404 от Telegram API
- Проверьте токен через `getMe`
- Убедитесь, что секрет установлен для правильного environment

### Ошибка 403 Forbidden
- Проверьте, что воркер деплоен на правильный endpoint
- Убедитесь, что функция экспортируется как default

## Интеграция с основной системой

Админ-бот использует общие ресурсы:
- База данных D1
- KV хранилище
- Переменные окружения

Но работает независимо от основного пользовательского бота. 