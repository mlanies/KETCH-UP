# Мотивационная система: массовая рассылка с ИИ по cron

## Описание

В Telegram-боте реализована автоматическая рассылка персональных мотивационных уведомлений с помощью ИИ (Cloudflare AI) по расписанию (cron) через Cloudflare Workers.

---

## Ключевые моменты реализации

1. **Персонализация**
   - Для каждого пользователя формируется уникальный промпт с его статистикой (уровень, прогресс, streak, достижения и т.д.).
   - Используется Cloudflare AI для генерации мотивационного сообщения.
   - Если ИИ недоступен — используется fallback-сообщение.

2. **Рассылка по cron**
   - В wrangler.toml cron-триггер настроен в корневой секции `[triggers]` для основного воркера (`telegram-wine-bot`).
   - Время рассылки: ежедневно в 21:59 по Москве (18:59 UTC).

3. **Экспорт функции scheduled**
   - В файле `src/index.js` экспортируется именованная функция `scheduled`, которая вызывает рассылку.
   - В начале и конце функции добавлены логи для диагностики.

4. **Очередная отправка сообщений**
   - Сообщения отправляются строго по очереди (await в цикле), чтобы не превышать лимит времени выполнения воркера и не перегружать ИИ.

5. **Миграция базы данных**
   - В таблицу `users` добавлен столбец `last_motivation_sent` для отслеживания времени последней рассылки.

6. **Логирование и диагностика**
   - В коде добавлены подробные логи для отслеживания прогресса рассылки и ошибок.

---

## Пример промпта для ИИ

```
Ты корпоративный наставник и мотиватор. Вот данные о сотруднике:
- Уровень: ...
- Прогресс: ...
- Последний урок: ...
- Серия правильных ответов: ...
- Ошибок за всё время: ...
- Достижения: ...
- Сильные стороны: ...
- Слабые стороны: ...
- Любимая категория: ...
- Время суток: ...
- Динамика: ...
- До следующего уровня: ... XP

Сформулируй короткое (до 200 символов) мотивационное сообщение, поздравь с достижениями, подскажи, что осталось до следующей цели, предложи пройти урок по слабой теме, пожелай хорошего дня. Используй дружелюбный стиль, эмодзи, вариативные фразы, вопросы, челленджи, поздравления, пожелания. Не повторяйся каждый день!
```

---

## Рекомендации

- Для масштабирования использовать батчи или очереди (Cloudflare Queues).
- Следить за лимитами времени выполнения воркера.
- При необходимости добавить задержку между отправками.
- Описать процесс в README и поддерживать документацию в актуальном состоянии. 