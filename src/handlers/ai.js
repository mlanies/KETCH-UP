// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI (Cloudflare AI)

import { getWineData } from './data.js';
import { jsonResponse } from '../utils/cors.js';

// –ö—ç—à –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò
const aiResponseCache = new Map();
const CACHE_DURATION = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
function getCachedResponse(question, wineId = null) {
  const cacheKey = wineId ? `${wineId}_${question}` : question;
  const cached = aiResponseCache.get(cacheKey);
  
  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
    return cached.response;
  }
  
  return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ –∫—ç—à
function setCachedResponse(question, response, wineId = null) {
  const cacheKey = wineId ? `${wineId}_${question}` : question;
  aiResponseCache.set(cacheKey, {
    response,
    timestamp: Date.now()
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∫—ç—à–∞
function cleanupCache() {
  const now = Date.now();
  for (const [key, value] of aiResponseCache.entries()) {
    if (now - value.timestamp > CACHE_DURATION) {
      aiResponseCache.delete(key);
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
function createPersonalizedPrompt(basePrompt, userContext = {}) {
  let personalizedPrompt = '';
  if (userContext.first_name) {
    personalizedPrompt += `${userContext.first_name}, `;
  } else if (userContext.username) {
    personalizedPrompt += `${userContext.username}, `;
  }
  personalizedPrompt += basePrompt;
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (userContext.difficulty) {
    personalizedPrompt += `\n\n–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userContext.difficulty}`;
  }
  if (userContext.preferences) {
    personalizedPrompt += `\n\n–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userContext.preferences.join(', ')}`;
  }
  if (userContext.previousQuestions) {
    personalizedPrompt += `\n\n–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userContext.previousQuestions.slice(-3).join(', ')}`;
  }
  return personalizedPrompt;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞
function optimizePrompt(prompt, maxLength = 4000) {
  if (prompt.length <= maxLength) {
    return prompt;
  }
  
  // –£–¥–∞–ª—è–µ–º –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç–∞
  const lines = prompt.split('\n');
  const essentialLines = [];
  let currentLength = 0;
  
  for (const line of lines) {
    if (currentLength + line.length > maxLength) {
      break;
    }
    
    // –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ–º –≤–∞–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (line.includes('–¢—ã —ç–∫—Å–ø–µ—Ä—Ç') || 
        line.includes('–û–¢–í–ï–ß–ê–ô') || 
        line.includes('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–∏—Ç–∫–µ') ||
        line.includes('–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞')) {
      essentialLines.push(line);
      currentLength += line.length;
    }
  }
  
  return essentialLines.join('\n');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ò–ò —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞
export async function askCloudflareAIWithWineContext(question, wineId, env, userContext = {}) {
  console.log('=== askCloudflareAIWithWineContext START ===');
  console.log('question:', question);
  console.log('wineId:', wineId);
  console.log('userContext:', userContext);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  const cachedResponse = getCachedResponse(question, wineId);
  if (cachedResponse) {
    console.log('Using cached response');
    return cachedResponse;
  }
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –Ω–∞–ø–∏—Ç–∫–µ
    const wines = await getWineData(env);
    const wine = wines.find(w => w.id === wineId);
    
    if (!wine) {
      console.log('Wine not found');
      return '–ò–∑–≤–∏–Ω–∏—Ç–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–∏—Ç–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
    }

    console.log('Wine found:', wine.name);

    // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –Ω–∞–ø–∏—Ç–∫–µ
    let wineContext = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${wine.name}\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${wine.category}\n`;
    
    if (wine.category === '–í–∏—Å–∫–∏') {
      wineContext += `–°—Ç—Ä–∞–Ω–∞: ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–ö—Ä–µ–ø–æ—Å—Ç—å: ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–¢–∏–ø: ${wine.type || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–í—ã–¥–µ—Ä–∂–∫–∞: ${wine.aging || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n`;
    } else if (wine.category === '–ü–∏–≤–æ') {
      wineContext += `–°—Ç—Ä–∞–Ω–∞: ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–ü–ª–æ—Ç–Ω–æ—Å—Ç—å: ${wine.density || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–ö—Ä–µ–ø–æ—Å—Ç—å: ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n`;
    } else if (wine.category === '–ö–æ–∫—Ç–µ–π–ª–∏' || wine.category === '–ú–∏–∫—Å –¥—Ä–∏–Ω–∫' || wine.category === '–õ–∏–º–æ–Ω–∞–¥—ã –∏ –ú–∏–ª–∫—à–µ–π–∫–∏' || wine.category === '–ö–æ—Ñ–µ') {
      wineContext += `–ú–µ—Ç–æ–¥: ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–ü–æ—Å—É–¥–∞: ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–õ–µ–¥: ${wine.ice || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–°–æ—Å—Ç–∞–≤: ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
    } else if (wine.category === '–ß–∞–π') {
      wineContext += `–°–æ—Å—Ç–∞–≤: ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–ú–µ—Ç–æ–¥: ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
    } else if (wine.category === '–ü—Ä–µ–º–∏–∫—Å—ã') {
      wineContext += `–°–æ—Å—Ç–∞–≤: ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
    } else if (wine.category === '–ü–§') {
      wineContext += `–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${wine.subcategory || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–°–æ—Å—Ç–∞–≤: ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
    } else if (wine.category === '–Ω–µ—Ç –≤ –º–µ–Ω—é') {
      wineContext += `–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${wine.subcategory || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–ú–µ—Ç–æ–¥: ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–ü–æ—Å—É–¥–∞: ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–õ–µ–¥: ${wine.ice || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–°–æ—Å—Ç–∞–≤: ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n`;
    } else {
      wineContext += `–°–∞—Ö–∞—Ä: ${wine.sugar || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n–ö—Ä–µ–ø–æ—Å—Ç—å: ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n–°—Ç—Ä–∞–Ω–∞: ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n`;
    }
    
    wineContext += `–û–ø–∏—Å–∞–Ω–∏–µ: ${wine.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}`;

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞
    let systemPrompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-—Å–æ–º–µ–ª—å–µ –∏ –±–∞—Ä–º–µ–Ω —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö –≤—ã—Å–æ–∫–æ–π –∫—É—Ö–Ω–∏. –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞—Ö –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∑–Ω–∞–µ—à—å –≤—Å–µ –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ, —Ö—Ä–∞–Ω–µ–Ω–∏–∏, –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ –∏ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –±–ª—é–¥–∞–º–∏.

–û–¢–í–ï–ß–ê–ô –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–∏—Ç–∫–µ:
${wineContext}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ —ç—Ç–æ–º—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –Ω–∞–ø–∏—Ç–∫—É.`;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (wine.category === '–ö–æ–∫—Ç–µ–π–ª–∏' || wine.category === '–ú–∏–∫—Å –¥—Ä–∏–Ω–∫') {
      systemPrompt += `

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ö–û–ö–¢–ï–ô–õ–Ø–ú:
- –ó–Ω–∞–µ—à—å –≤—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: Build, Shake, Stir, Muddle, Layer, Roll
- –ü–æ–Ω–∏–º–∞–µ—à—å –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ—Å—É–¥—ã –∏ –ª—å–¥–∞
- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∏ –ø–æ–¥–∞—á–∏
- –ó–Ω–∞–µ—à—å –∏—Å—Ç–æ—Ä–∏—é –∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∫–æ–∫—Ç–µ–π–ª–µ–π
- –ú–æ–∂–µ—à—å –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É–∫—Ä–∞—à–µ–Ω–∏—é –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –ú–µ—Ç–æ–¥–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∏ —Ç–µ—Ö–Ω–∏–∫–µ
- –í—ã–±–æ—Ä–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å—É–¥—ã –∏ –ª—å–¥–∞
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
- –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –±–ª—é–¥–∞–º–∏
- –ò—Å—Ç–æ—Ä–∏–∏ –∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –∫–æ–∫—Ç–µ–π–ª—è
- –í–∞—Ä–∏–∞—Ü–∏—è—Ö –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è—Ö
- –£–∫—Ä–∞—à–µ–Ω–∏–∏ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ`;
    } else if (wine.category === '–õ–∏–º–æ–Ω–∞–¥—ã –∏ –ú–∏–ª–∫—à–µ–π–∫–∏') {
      systemPrompt += `

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ë–ï–ó–ê–õ–ö–û–ì–û–õ–¨–ù–´–ú –ù–ê–ü–ò–¢–ö–ê–ú:
- –ó–Ω–∞–µ—à—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–æ–Ω–∞–¥–æ–≤ –∏ –º–∏–ª–∫—à–µ–π–∫–æ–≤
- –ü–æ–Ω–∏–º–∞–µ—à—å –≤–∞–∂–Ω–æ—Å—Ç—å —Å–≤–µ–∂–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
- –ú–æ–∂–µ—à—å –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É–∫—Ä–∞—à–µ–Ω–∏—é –∏ –ø–æ–¥–∞—á–µ
- –ó–Ω–∞–µ—à—å –æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞—Ö
- –ü–æ–¥–∞—á–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
- –£–∫—Ä–∞—à–µ–Ω–∏–∏ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ
- –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
- –í–∞—Ä–∏–∞—Ü–∏—è—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤`;
    } else if (wine.category === '–ß–∞–π') {
      systemPrompt += `

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ß–ê–Æ:
- –ó–Ω–∞–µ—à—å –≤—Å–µ –≤–∏–¥—ã —á–∞—è –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –ü–æ–Ω–∏–º–∞–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è
- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤
- –ó–Ω–∞–µ—à—å –æ –ø–æ–ª—å–∑–µ –∏ —Å–≤–æ–π—Å—Ç–≤–∞—Ö —á–∞—è

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–º –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–∏
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –∏ –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–¥–∞—á–µ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ
- –ü–æ–ª—å–∑–µ –∏ —Å–≤–æ–π—Å—Ç–≤–∞—Ö
- –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –µ–¥–æ–π`;
    } else if (wine.category === '–ö–æ—Ñ–µ') {
      systemPrompt += `

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ö–û–§–ï:
- –ó–Ω–∞–µ—à—å –≤—Å–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ñ–µ
- –ü–æ–Ω–∏–º–∞–µ—à—å –≤–∞–∂–Ω–æ—Å—Ç—å –ø–æ–º–æ–ª–∞ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Å–æ—Ä—Ç–∞–º–∏
- –ó–Ω–∞–µ—à—å –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ –∫–æ—Ñ–µ

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –°–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
- –í—ã–±–æ—Ä–µ –∑–µ—Ä–µ–Ω –∏ –ø–æ–º–æ–ª–∞
- –ü–æ–¥–∞—á–µ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–µ
- –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –¥–µ—Å–µ—Ä—Ç–∞–º–∏
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –ø–æ–¥–∞—á–∏`;
    } else if (wine.category === '–ü—Ä–µ–º–∏–∫—Å—ã') {
      systemPrompt += `

–°–ü–ï–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ü–†–ï–ú–ò–ö–°–ê–ú:
- –ó–Ω–∞–µ—à—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–º–∏–∫—Å–∞–º–∏
- –ü–æ–Ω–∏–º–∞–µ—à—å –∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏
- –ú–æ–∂–µ—à—å –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Ö—Ä–∞–Ω–µ–Ω–∏—é
- –ó–Ω–∞–µ—à—å –æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–∫—Ç–µ–π–ª–µ–π –∏–∑ –ø—Ä–µ–º–∏–∫—Å–æ–≤

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –•—Ä–∞–Ω–µ–Ω–∏–∏ –∏ —Å—Ä–æ–∫–µ –≥–æ–¥–Ω–æ—Å—Ç–∏
- –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–∫—Ç–µ–π–ª–µ–π
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞—Ö
- –í–∞—Ä–∏–∞—Ü–∏—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è`;
    } else {
      systemPrompt += `

–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
- –í—ã–±–æ—Ä–µ –±–æ–∫–∞–ª–æ–≤
- –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –±–ª—é–¥–∞–º–∏
- –•—Ä–∞–Ω–µ–Ω–∏–∏ –∏ –≤—ã–¥–µ—Ä–∂–∫–µ
- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö
- –ò—Å—Ç–æ—Ä–∏–∏ –∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏`;
    }

    systemPrompt += `

–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å —ç—Ç–∏–º –Ω–∞–ø–∏—Ç–∫–æ–º, –≤–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ —Ç–µ–º–µ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞.`;

    // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    const personalizedPrompt = createPersonalizedPrompt(systemPrompt, userContext);
    const fullPrompt = `${personalizedPrompt}\n\n–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: ${question}\n\n–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è:`;

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
    const optimizedPrompt = optimizePrompt(fullPrompt);
    console.log('Prompt length:', optimizedPrompt.length);

    // –ü—Ä–æ–±—É–µ–º Cloudflare AI –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if (env.CLOUDFLARE_ACCOUNT_ID && env.CLOUDFLARE_AI_TOKEN) {
      try {
        console.log('Calling Cloudflare AI...');
        const endpoint = `https://api.cloudflare.com/client/v4/accounts/${env.CLOUDFLARE_ACCOUNT_ID}/ai/run/@cf/meta/llama-3-8b-instruct`;
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${env.CLOUDFLARE_AI_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ prompt: optimizedPrompt })
        });
        
        const data = await response.json();
        console.log('Cloudflare AI response status:', response.status);
        
        if (data.result && data.result.response) {
          const aiResponse = data.result.response.trim();
          console.log('AI response received, length:', aiResponse.length);
          
          // –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
          setCachedResponse(question, aiResponse, wineId);
          
          console.log('=== askCloudflareAIWithWineContext END ===');
          return aiResponse;
        } else if (data.errors && data.errors.length > 0) {
          console.error('Cloudflare AI error:', data.errors[0].message);
        }
      } catch (e) {
        console.error('Cloudflare AI request error:', e);
        console.error('Error stack:', e.stack);
      }
    } else {
      console.log('Cloudflare AI not configured');
    }

    // –£–ª—É—á—à–µ–Ω–Ω—ã–µ fallback –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞
    const lowerQuestion = question.toLowerCase();
    const lowerWineName = wine.name.toLowerCase();
    
    let fallbackResponse = generateFallbackResponse(lowerQuestion, wine);
    
    // –ö—ç—à–∏—Ä—É–µ–º fallback –æ—Ç–≤–µ—Ç
    setCachedResponse(question, fallbackResponse, wineId);
    
    console.log('=== askCloudflareAIWithWineContext END ===');
    return fallbackResponse;
    
  } catch (error) {
    console.error('Error in askCloudflareAIWithWineContext:', error);
    console.error('Error stack:', error.stack);
    
    return `‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.

üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${error.message}`;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ fallback –æ—Ç–≤–µ—Ç–æ–≤
function generateFallbackResponse(lowerQuestion, wine) {
  if (lowerQuestion.includes('–ø–æ–¥–∞—á–∞') || lowerQuestion.includes('—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞') || lowerQuestion.includes('–±–æ–∫–∞–ª')) {
    if (wine.category === '–ö–æ–∫—Ç–µ–π–ª–∏' || wine.category === '–ú–∏–∫—Å –¥—Ä–∏–Ω–∫') {
      return `üçπ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

ü•§ **–ú–µ—Ç–æ–¥ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:** ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
ü•Ç **–ü–æ—Å—É–¥–∞:** ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
üßä **–õ–µ–¥:** ${wine.ice || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** –û—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–π (4-8¬∞C)
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

üí° *–°–æ–≤–µ—Ç:* ${wine.name} - —ç—Ç–æ ${wine.category.toLowerCase()}. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –º–µ—Ç–æ–¥ "${wine.method}" –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ—Å—É–¥—ã "${wine.glassware}".`;
    } else if (wine.category === '–õ–∏–º–æ–Ω–∞–¥—ã –∏ –ú–∏–ª–∫—à–µ–π–∫–∏') {
      return `ü•§ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

ü•§ **–ú–µ—Ç–æ–¥ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:** ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
ü•Ç **–ü–æ—Å—É–¥–∞:** ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
üßä **–õ–µ–¥:** ${wine.ice || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** –û—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–π (2-6¬∞C)
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

üí° *–°–æ–≤–µ—Ç:* ${wine.name} - –æ—Å–≤–µ–∂–∞—é—â–∏–π –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∂–∞—Ä–∫–æ–π –ø–æ–≥–æ–¥—ã.`;
    } else if (wine.category === '–ß–∞–π') {
      return `üçµ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

üçµ **–°–æ—Å—Ç–∞–≤:** ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
‚òï **–ú–µ—Ç–æ–¥ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è:** ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** –ì–æ—Ä—è—á–∏–π (70-85¬∞C)
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –ó–∞–≤–∞—Ä–∏–≤–∞–π—Ç–µ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

üí° *–°–æ–≤–µ—Ç:* ${wine.name} –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è.`;
    } else if (wine.category === '–ö–æ—Ñ–µ') {
      return `‚òï *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

‚òï **–ú–µ—Ç–æ–¥ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:** ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
ü•Ç **–ü–æ—Å—É–¥–∞:** ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** –ì–æ—Ä—è—á–∏–π (85-90¬∞C)
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

üí° *–°–æ–≤–µ—Ç:* ${wine.name} - –∞—Ä–æ–º–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ. –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å —Å–∞—Ö–∞—Ä–æ–º –∏ –º–æ–ª–æ–∫–æ–º –ø–æ –∂–µ–ª–∞–Ω–∏—é.`;
    } else if (wine.category === '–í–∏–Ω–∞') {
      let temp = '8-12¬∞C';
      let glass = '–±–æ–∫–∞–ª –¥–ª—è –≤–∏–Ω–∞';
      
      if (wine.sugar === '–ë—Ä—é—Ç') {
        temp = '6-8¬∞C';
        glass = '—Ñ–ª–µ–π—Ç–∞ –¥–ª—è –∏–≥—Ä–∏—Å—Ç–æ–≥–æ';
      } else if (wine.sugar === '–°—É—Ö–æ–µ') {
        temp = '8-12¬∞C';
        glass = '–±–æ–∫–∞–ª –¥–ª—è –≤–∏–Ω–∞';
      } else if (wine.sugar === '–ü–æ–ª—É—Å–ª–∞–¥–∫–æ–µ') {
        temp = '10-12¬∞C';
        glass = '–±–æ–∫–∞–ª –¥–ª—è –¥–µ—Å–µ—Ä—Ç–Ω–æ–≥–æ –≤–∏–Ω–∞';
      }
      
      return `üç∑ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** ${temp}
ü•Ç **–ë–æ–∫–∞–ª:** ${glass}
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –û—Ç–∫—Ä–æ–π—Ç–µ –∑–∞ 15-30 –º–∏–Ω—É—Ç –¥–æ –ø–æ–¥–∞—á–∏
üçΩÔ∏è **–ü–æ–¥–∞—á–∞:** –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º–∏ –±–ª—é–¥–∞–º–∏

üí° *–°–æ–≤–µ—Ç:* –î–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∞—Ä–æ–º–∞—Ç–∞ —Å–ª–µ–≥–∫–∞ –ø–æ–∫–∞—á–∞–π—Ç–µ –±–æ–∫–∞–ª –ø–µ—Ä–µ–¥ –¥–µ–≥—É—Å—Ç–∞—Ü–∏–µ–π.`;
    } else if (wine.category === '–í–∏—Å–∫–∏') {
      return `ü•É *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** 18-22¬∞C
ü•É **–ë–æ–∫–∞–ª:** —Å—Ç–∞–∫–∞–Ω –¥–ª—è –≤–∏—Å–∫–∏ (tumbler) –∏–ª–∏ –±–æ–∫–∞–ª –¥–ª—è –≤–∏—Å–∫–∏
üßä **–õ–µ–¥:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 1-2 –∫—É–±–∏–∫–∞ –ª—å–¥–∞ –∏–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –≤–æ–¥—ã
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –î–∞–π—Ç–µ –ø–æ—Å—Ç–æ—è—Ç—å 5-10 –º–∏–Ω—É—Ç –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∞—Ä–æ–º–∞—Ç–∞

üí° *–°–æ–≤–µ—Ç:* –î–ª—è ${wine.type || '—ç—Ç–æ–≥–æ –≤–∏—Å–∫–∏'} –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç —á–∏—Å—Ç–∞—è –≤–æ–¥–∞ –∫–æ–º–Ω–∞—Ç–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã.`;
    } else if (wine.category === '–ü–∏–≤–æ') {
      return `üç∫ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ ${wine.name}*

üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:** 4-8¬∞C
üç∫ **–ë–æ–∫–∞–ª:** –ø–∏–≤–Ω–æ–π –±–æ–∫–∞–ª –∏–ª–∏ –∫—Ä—É–∂–∫–∞
‚è∞ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:** –ü–æ–¥–∞–≤–∞–π—Ç–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
üßä **–õ–µ–¥:** –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ª–µ–¥ –≤ –ø–∏–≤–æ

üí° *–°–æ–≤–µ—Ç:* ${wine.name} –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –ø–æ–¥–∞—á–∏.`;
    }
  }
  
  // –û–±—â–∏–π fallback –æ—Ç–≤–µ—Ç
  return `üç∑ *–û –Ω–∞–ø–∏—Ç–∫–µ ${wine.name}*

üìã **–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${wine.category}
‚Ä¢ ${wine.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}

üí° *–ó–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ:*
‚Ä¢ –ü–æ–¥–∞—á–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
‚Ä¢ –•—Ä–∞–Ω–µ–Ω–∏–∏
‚Ä¢ –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –±–ª—é–¥–∞–º–∏
‚Ä¢ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
‚Ä¢ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ò–ò —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö
export async function askCloudflareAI(question, env, userContext = {}) {
  console.log('=== askCloudflareAI START ===');
  console.log('question:', question);
  console.log('userContext:', userContext);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
  const cachedResponse = getCachedResponse(question);
  if (cachedResponse) {
    console.log('Using cached response');
    return cachedResponse;
  }
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const wines = await getWineData(env);
    
    // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö
    const wineContext = wines ? wines.slice(0, 30).map(wine => {
      let info = `${wine.name} (${wine.category})`;
      if (wine.category === '–í–∏—Å–∫–∏') {
        info += ` - ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'}, ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫—Ä–µ–ø–æ—Å—Ç—å'}, ${wine.type || '–Ω–µ —É–∫–∞–∑–∞–Ω —Ç–∏–ø'}`;
      } else if (wine.category === '–ü–∏–≤–æ') {
        info += ` - ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'}, ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫—Ä–µ–ø–æ—Å—Ç—å'}, ${wine.density || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å'}`;
      } else if (wine.category === '–ö–æ–∫—Ç–µ–π–ª–∏' || wine.category === '–ú–∏–∫—Å –¥—Ä–∏–Ω–∫') {
        info += ` - ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥'}, ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–æ—Å—É–¥–∞'}, ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω —Å–æ—Å—Ç–∞–≤'}`;
      } else if (wine.category === '–õ–∏–º–æ–Ω–∞–¥—ã –∏ –ú–∏–ª–∫—à–µ–π–∫–∏') {
        info += ` - ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥'}, ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–æ—Å—É–¥–∞'}, –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π`;
      } else if (wine.category === '–ß–∞–π') {
        info += ` - ${wine.ingredients || '–Ω–µ —É–∫–∞–∑–∞–Ω —Å–æ—Å—Ç–∞–≤'}, ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è'}`;
      } else if (wine.category === '–ö–æ—Ñ–µ') {
        info += ` - ${wine.method || '–Ω–µ —É–∫–∞–∑–∞–Ω –º–µ—Ç–æ–¥'}, ${wine.glassware || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø–æ—Å—É–¥–∞'}`;
      } else {
        info += ` - ${wine.sugar || '–Ω–µ —É–∫–∞–∑–∞–Ω —Å–∞—Ö–∞—Ä'}, ${wine.alcohol || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –∫—Ä–µ–ø–æ—Å—Ç—å'}, ${wine.country || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'}`;
      }
      return info;
    }).join('\n') : '';

    console.log('Wine context created, length:', wineContext.length);

    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    const systemPrompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-—Å–æ–º–µ–ª—å–µ –∏ –±–∞—Ä–º–µ–Ω —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö –≤—ã—Å–æ–∫–æ–π –∫—É—Ö–Ω–∏. –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤: –≤–∏–Ω–∞—Ö, –≤–∏—Å–∫–∏, —Ä–æ–º–µ, —Ç–µ–∫–∏–ª–µ, –¥–∂–∏–Ω–µ, –≤–æ–¥–∫–µ, –ª–∏–∫–µ—Ä–∞—Ö, –ø–∏–≤–µ, –∫–æ–∫—Ç–µ–π–ª—è—Ö, –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–∞—Ö, —á–∞–µ –∏ –∫–æ—Ñ–µ.

–û–¢–í–ï–ß–ê–ô –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–∏—Ç–∫–∞—Ö –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞:
${wineContext}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –Ω–∞–ø–∏—Ç–∫–∞–º. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –í–∏–¥–∞—Ö –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ
- –í—ã–±–æ—Ä–µ –±–æ–∫–∞–ª–æ–≤ –∏ –ø–æ—Å—É–¥—ã
- –°–æ—á–µ—Ç–∞–Ω–∏–∏ —Å –±–ª—é–¥–∞–º–∏
- –•—Ä–∞–Ω–µ–Ω–∏–∏ –∏ –≤—ã–¥–µ—Ä–∂–∫–µ
- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö
- –ò—Å—Ç–æ—Ä–∏–∏ –∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤
- –†–µ–≥–∏–æ–Ω–∞—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
- –ú–µ—Ç–æ–¥–∞—Ö –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∫–æ–∫—Ç–µ–π–ª–µ–π
- –¢–µ—Ö–Ω–∏–∫–∞—Ö –±–∞—Ä–º–µ–Ω—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞
- –ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–∞—Ö –∏ –∏—Ö –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏
- –ó–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–∏ —á–∞—è –∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ñ–µ

–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –Ω–∞–ø–∏—Ç–∫–∞–º–∏, –≤–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ —Ç–µ–º–µ –Ω–∞–ø–∏—Ç–∫–æ–≤.`;

    // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    const personalizedPrompt = createPersonalizedPrompt(systemPrompt, userContext);
    const fullPrompt = `${personalizedPrompt}\n\n–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: ${question}\n\n–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è:`;

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
    const optimizedPrompt = optimizePrompt(fullPrompt);
    console.log('Prompt length:', optimizedPrompt.length);

    // –ü—Ä–æ–±—É–µ–º Cloudflare AI –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
    if (env.CLOUDFLARE_ACCOUNT_ID && env.CLOUDFLARE_AI_TOKEN) {
      try {
        console.log('Calling Cloudflare AI...');
        const endpoint = `https://api.cloudflare.com/client/v4/accounts/${env.CLOUDFLARE_ACCOUNT_ID}/ai/run/@cf/meta/llama-3-8b-instruct`;
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${env.CLOUDFLARE_AI_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ prompt: optimizedPrompt })
        });
        
        const data = await response.json();
        console.log('Cloudflare AI response status:', response.status);
        
        if (data.result && data.result.response) {
          const aiResponse = data.result.response.trim();
          console.log('AI response received, length:', aiResponse.length);
          
          // –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
          setCachedResponse(question, aiResponse);
          
          console.log('=== askCloudflareAI END ===');
          return aiResponse;
        } else if (data.errors && data.errors.length > 0) {
          console.error('Cloudflare AI error:', data.errors[0].message);
        }
      } catch (e) {
        console.error('Cloudflare AI request error:', e);
        console.error('Error stack:', e.stack);
      }
      } else {
    console.log('Cloudflare AI not configured');
  }

  // –£–ª—É—á—à–µ–Ω–Ω—ã–µ fallback –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  const lowerQuestion = question.toLowerCase();
  
  let fallbackResponse = generateGeneralFallbackResponse(lowerQuestion);
  
  // –ö—ç—à–∏—Ä—É–µ–º fallback –æ—Ç–≤–µ—Ç
  setCachedResponse(question, fallbackResponse);
  
  console.log('=== askCloudflareAI END ===');
  return fallbackResponse;
  
  } catch (error) {
    console.error('Error in askCloudflareAI:', error);
    console.error('Error stack:', error.stack);
    
    return `‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.

üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${error.message}`;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—â–∏—Ö fallback –æ—Ç–≤–µ—Ç–æ–≤
function generateGeneralFallbackResponse(lowerQuestion) {
  
  if (lowerQuestion.includes('—Å—É—Ö–æ–µ') || lowerQuestion.includes('–ø–æ–ª—É—Å—É—Ö–æ–µ') || lowerQuestion.includes('—Å–ª–∞–¥–∫–æ–µ') || lowerQuestion.includes('—Å–∞—Ö–∞—Ä')) {
    return `üç∑ *–û —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ —Å–∞—Ö–∞—Ä–∞ –≤ –Ω–∞–ø–∏—Ç–∫–∞—Ö*

**–í–∏–Ω–∞:**
‚Ä¢ ü•Ç **–ë—Ä—é—Ç** - –º–µ–Ω–µ–µ 6 –≥/–ª —Å–∞—Ö–∞—Ä–∞, –æ—á–µ–Ω—å —Å—É—Ö–æ–µ –∏–≥—Ä–∏—Å—Ç–æ–µ
‚Ä¢ üç∑ **–°—É—Ö–æ–µ** - –º–µ–Ω–µ–µ 4 –≥/–ª —Å–∞—Ö–∞—Ä–∞, —á–∏—Å—Ç—ã–π, —Å–≤–µ–∂–∏–π –≤–∫—É—Å
‚Ä¢ üç∑ **–ü–æ–ª—É—Å—É—Ö–æ–µ** - 4-12 –≥/–ª —Å–∞—Ö–∞—Ä–∞, –±–æ–ª–µ–µ –º—è–≥–∫–∏–π –≤–∫—É—Å  
‚Ä¢ üç∑ **–ü–æ–ª—É—Å–ª–∞–¥–∫–æ–µ** - 12-45 –≥/–ª —Å–∞—Ö–∞—Ä–∞, —Å–ª–∞–¥–∫–æ–≤–∞—Ç—ã–π –≤–∫—É—Å
‚Ä¢ üç∑ **–°–ª–∞–¥–∫–æ–µ** - –±–æ–ª–µ–µ 45 –≥/–ª —Å–∞—Ö–∞—Ä–∞, –¥–µ—Å–µ—Ä—Ç–Ω–æ–µ –≤–∏–Ω–æ

**–ö—Ä–µ–ø–∫–∏–µ —Å–ø–∏—Ä—Ç—ã:**
‚Ä¢ ü•É **–°—É—Ö–æ–π** - –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∞—Ö–∞—Ä–∞ (–≤–∏—Å–∫–∏, —Ä–æ–º, –¥–∂–∏–Ω, –≤–æ–¥–∫–∞)
‚Ä¢ üçØ **–°–ª–∞–¥–∫–∏–π** - —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å–∞—Ö–∞—Ä–∞ (–ª–∏–∫–µ—Ä—ã, –≤–µ—Ä–º—É—Ç—ã)

üí° *–°–æ–≤–µ—Ç:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä "–ü–æ —Å–∞—Ö–∞—Ä—É" –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤.`;
  }
  
  if (lowerQuestion.includes('–∫—Ä–µ–ø–æ—Å—Ç—å') || lowerQuestion.includes('–∞–ª–∫–æ–≥–æ–ª—å') || lowerQuestion.includes('%')) {
    return `ü•É *–û –∫—Ä–µ–ø–æ—Å—Ç–∏ –Ω–∞–ø–∏—Ç–∫–æ–≤*

**–í–∏–Ω–∞:**
‚Ä¢ üç∑ **–õ–µ–≥–∫–∏–µ** - 8-11% –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ üç∑ **–°—Ä–µ–¥–Ω–∏–µ** - 11-13% –∞–ª–∫–æ–≥–æ–ª—è  
‚Ä¢ üç∑ **–ö—Ä–µ–ø–∫–∏–µ** - 13-15% –∞–ª–∫–æ–≥–æ–ª—è

**–ö—Ä–µ–ø–∫–∏–µ —Å–ø–∏—Ä—Ç—ã:**
‚Ä¢ ü•É **–í–∏—Å–∫–∏, –†–æ–º, –î–∂–∏–Ω, –í–æ–¥–∫–∞** - 35-45% –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ ü•É **–ö–æ–Ω—å—è–∫, –ë—Ä–µ–Ω–¥–∏** - 40-45% –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ üçØ **–õ–∏–∫–µ—Ä—ã** - 15-30% –∞–ª–∫–æ–≥–æ–ª—è

**–ü–∏–≤–æ:**
‚Ä¢ üç∫ **–õ–µ–≥–∫–æ–µ** - 3-4% –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ üç∫ **–°—Ä–µ–¥–Ω–µ–µ** - 4-6% –∞–ª–∫–æ–≥–æ–ª—è
‚Ä¢ üç∫ **–ö—Ä–µ–ø–∫–æ–µ** - 6-8% –∞–ª–∫–æ–≥–æ–ª—è

üí° *–°–æ–≤–µ—Ç:* –ö—Ä–µ–ø–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∫—É—Å –∏ —Å–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ –Ω–∞–ø–∏—Ç–∫–∞.`;
  }
  
  if (lowerQuestion.includes('—Å—Ç—Ä–∞–Ω–∞') || lowerQuestion.includes('—Ä–µ–≥–∏–æ–Ω')) {
    return `üåç *–û —Ä–µ–≥–∏–æ–Ω–∞—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞–ø–∏—Ç–∫–æ–≤*

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ä–µ–≥–∏–æ–Ω—ã:**
‚Ä¢ üá´üá∑ **–§—Ä–∞–Ω—Ü–∏—è** - –≤–∏–Ω–∞, –∫–æ–Ω—å—è–∫–∏, —à–∞–º–ø–∞–Ω—Å–∫–æ–µ
‚Ä¢ üáÆüáπ **–ò—Ç–∞–ª–∏—è** - –≤–∏–Ω–∞, –≥—Ä–∞–ø–ø–∞, –≤–µ—Ä–º—É—Ç—ã
‚Ä¢ üá™üá∏ **–ò—Å–ø–∞–Ω–∏—è** - –≤–∏–Ω–∞, –ø–æ—Ä—Ç–æ, —Ö–µ—Ä–µ—Å
‚Ä¢ üá∫üá∏ **–°–®–ê** - –≤–∏—Å–∫–∏, –≤–∏–Ω–∞, –∫—Ä–∞—Ñ—Ç–æ–≤–æ–µ –ø–∏–≤–æ
‚Ä¢ üá¨üáß **–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è** - –¥–∂–∏–Ω, –≤–∏—Å–∫–∏, —ç–ª—å
‚Ä¢ üá≤üáΩ **–ú–µ–∫—Å–∏–∫–∞** - —Ç–µ–∫–∏–ª–∞, –º–µ—Å–∫–∞–ª—å
‚Ä¢ üá®üá∫ **–ö—É–±–∞** - —Ä–æ–º
‚Ä¢ üáØüáµ **–Ø–ø–æ–Ω–∏—è** - –≤–∏—Å–∫–∏, —Å–∞–∫–µ

**–ù–æ–≤—ã–µ —Ä–µ–≥–∏–æ–Ω—ã:**
‚Ä¢ üá¶üá∫ **–ê–≤—Å—Ç—Ä–∞–ª–∏—è** - –≤–∏–Ω–∞, –≤–∏—Å–∫–∏
‚Ä¢ üá®üá± **–ß–∏–ª–∏** - –≤–∏–Ω–∞
‚Ä¢ üáøüá¶ **–Æ–ê–†** - –≤–∏–Ω–∞
‚Ä¢ üáßüá∑ **–ë—Ä–∞–∑–∏–ª–∏—è** - –∫–∞—à–∞—Å–∞

üí° *–°–æ–≤–µ—Ç:* –ö–∞–∂–¥—ã–π —Ä–µ–≥–∏–æ–Ω –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞.`;
  }
  
  if (lowerQuestion.includes('–ø–æ–¥–∞—á–∞') || lowerQuestion.includes('—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞') || lowerQuestion.includes('–±–æ–∫–∞–ª')) {
    return `üç∑ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ –Ω–∞–ø–∏—Ç–∫–æ–≤*

**–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏:**
‚Ä¢ ü•Ç **–ò–≥—Ä–∏—Å—Ç—ã–µ –≤–∏–Ω–∞** - 6-8¬∞C
‚Ä¢ üç∑ **–ë–µ–ª—ã–µ –≤–∏–Ω–∞** - 8-12¬∞C
‚Ä¢ üç∑ **–†–æ–∑–æ–≤—ã–µ –≤–∏–Ω–∞** - 10-12¬∞C
‚Ä¢ üç∑ **–ö—Ä–∞—Å–Ω—ã–µ –≤–∏–Ω–∞** - 16-18¬∞C
‚Ä¢ ü•É **–ö—Ä–µ–ø–∫–∏–µ —Å–ø–∏—Ä—Ç—ã** - 18-22¬∞C
‚Ä¢ üç∫ **–ü–∏–≤–æ** - 4-8¬∞C
‚Ä¢ üçπ **–ö–æ–∫—Ç–µ–π–ª–∏** - 4-8¬∞C (–æ—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–µ)
‚Ä¢ ü•§ **–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ** - 2-6¬∞C (–æ—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–µ)
‚Ä¢ üçµ **–ß–∞–π** - 70-85¬∞C (–≥–æ—Ä—è—á–∏–π)
‚Ä¢ ‚òï **–ö–æ—Ñ–µ** - 85-90¬∞C (–≥–æ—Ä—è—á–∏–π)

**–ë–æ–∫–∞–ª—ã –∏ –ø–æ—Å—É–¥–∞:**
‚Ä¢ ü•Ç **–ò–≥—Ä–∏—Å—Ç–æ–µ** - —Ñ–ª–µ–π—Ç—ã –∏–ª–∏ —Ç—é–ª—å–ø–∞–Ω—ã
‚Ä¢ üç∑ **–ö—Ä–∞—Å–Ω–æ–µ –≤–∏–Ω–æ** - –±–æ–∫–∞–ª—ã —Å —à–∏—Ä–æ–∫–æ–π —á–∞—à–µ–π
‚Ä¢ üç∑ **–ë–µ–ª–æ–µ –≤–∏–Ω–æ** - –±–æ–∫–∞–ª—ã —Å —É–∑–∫–æ–π —á–∞—à–µ–π
‚Ä¢ ü•É **–í–∏—Å–∫–∏/–ö–æ–Ω—å—è–∫** - —Å—Ç–∞–∫–∞–Ω—ã –¥–ª—è –≤–∏—Å–∫–∏
‚Ä¢ üç∫ **–ü–∏–≤–æ** - –ø–∏–≤–Ω—ã–µ –±–æ–∫–∞–ª—ã
‚Ä¢ üçπ **–ö–æ–∫—Ç–µ–π–ª–∏** - –∫–æ–∫—Ç–µ–π–ª—å–Ω—ã–µ –±–æ–∫–∞–ª—ã, —Å—Ç–∞–∫–∞–Ω—ã
‚Ä¢ ü•§ **–õ–∏–º–æ–Ω–∞–¥—ã** - –≤—ã—Å–æ–∫–∏–µ —Å—Ç–∞–∫–∞–Ω—ã, –±–æ–∫–∞–ª—ã
‚Ä¢ üçµ **–ß–∞–π** - —á–∞–π–Ω—ã–µ —á–∞—à–∫–∏, –ø–∏–∞–ª—ã
‚Ä¢ ‚òï **–ö–æ—Ñ–µ** - –∫–æ—Ñ–µ–π–Ω—ã–µ —á–∞—à–∫–∏, —Å—Ç–∞–∫–∞–Ω—ã

üí° *–°–æ–≤–µ—Ç:* –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –ø–æ—Å—É–¥–∞ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –∏—Å—Ç–∏–Ω–Ω—ã–π –≤–∫—É—Å –Ω–∞–ø–∏—Ç–∫–∞.`;
  }
  
  if (lowerQuestion.includes('–∫–æ–∫—Ç–µ–π–ª—å') || lowerQuestion.includes('–º–∏–∫—Å') || lowerQuestion.includes('–±–∞—Ä–º–µ–Ω')) {
    return `üçπ *–û –∫–æ–∫—Ç–µ–π–ª—è—Ö –∏ –±–∞—Ä–º–µ–Ω—Å–∫–æ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ*

**–ú–µ—Ç–æ–¥—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:**
‚Ä¢ ü•§ **Build** - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ –±–æ–∫–∞–ª–µ
‚Ä¢ üßä **Shake** - –≤—Å—Ç—Ä—è—Ö–∏–≤–∞–Ω–∏–µ –≤ —à–µ–π–∫–µ—Ä–µ
‚Ä¢ ü•Ñ **Stir** - —Ä–∞–∑–º–µ—à–∏–≤–∞–Ω–∏–µ –ª–æ–∂–∫–æ–π
‚Ä¢ üçÉ **Muddle** - —Ä–∞–∑–º–∏–Ω–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
‚Ä¢ üåä **Layer** - –ø–æ—Å–ª–æ–π–Ω–æ–µ –Ω–∞–ª–∏–≤–∞–Ω–∏–µ
‚Ä¢ üîÑ **Roll** - –ø–µ—Ä–µ–∫–∞—Ç—ã–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –±–æ–∫–∞–ª–∞–º–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:**
‚Ä¢ ü•É **–ë–∞–∑–∞** - –≤–∏—Å–∫–∏, —Ä–æ–º, –¥–∂–∏–Ω, –≤–æ–¥–∫–∞, —Ç–µ–∫–∏–ª–∞
‚Ä¢ üçã **–¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ** - –ª–∏–º–æ–Ω, –ª–∞–π–º, –∞–ø–µ–ª—å—Å–∏–Ω
‚Ä¢ üçØ **–°–ª–∞–¥–∫–∏–µ** - —Å–∏—Ä–æ–ø—ã, —Å–∞—Ö–∞—Ä, –º–µ–¥
‚Ä¢ üßä **–õ–µ–¥** - –∫—É–±–∏–∫–∏, –¥—Ä–æ–±–ª–µ–Ω—ã–π, –ª–µ–¥—è–Ω–∞—è –∫—Ä–æ—à–∫–∞
‚Ä¢ üåø **–£–∫—Ä–∞—à–µ–Ω–∏—è** - –º—è—Ç–∞, —Ñ—Ä—É–∫—Ç—ã, —Ü–µ–¥—Ä–∞

**–ü–æ—Å—É–¥–∞:**
‚Ä¢ ü•§ **–®–µ–π–∫–µ—Ä** - –¥–ª—è –≤—Å—Ç—Ä—è—Ö–∏–≤–∞–Ω–∏—è
‚Ä¢ ü•Ñ **–ë–∞—Ä–Ω–∞—è –ª–æ–∂–∫–∞** - –¥–ª—è —Ä–∞–∑–º–µ—à–∏–≤–∞–Ω–∏—è
‚Ä¢ üßä **–ê–π—Å-–ø–∏–∫** - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –ª—å–¥–æ–º
‚Ä¢ üçπ **–°—Ç—Ä–µ–π–Ω–µ—Ä** - –¥–ª—è –ø—Ä–æ—Ü–µ–∂–∏–≤–∞–Ω–∏—è

üí° *–°–æ–≤–µ—Ç:* –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–∫—Ç–µ–π–ª—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–≤–µ–∂–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏.`;
  }

  if (lowerQuestion.includes('—Ö—Ä–∞–Ω–µ–Ω–∏–µ') || lowerQuestion.includes('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ')) {
    return `üè∫ *–•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–ø–∏—Ç–∫–æ–≤*

**–£—Å–ª–æ–≤–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:**
‚Ä¢ üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:** 10-15¬∞C –¥–ª—è –≤–∏–Ω, 15-20¬∞C –¥–ª—è —Å–ø–∏—Ä—Ç–æ–≤
‚Ä¢ üíß **–í–ª–∞–∂–Ω–æ—Å—Ç—å:** 70-80%
‚Ä¢ üåë **–û—Å–≤–µ—â–µ–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Ç–µ–º–Ω–æ—Ç–∞
‚Ä¢ üì¶ **–ü–æ–ª–æ–∂–µ–Ω–∏–µ:** –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –¥–ª—è –±—É—Ç—ã–ª–æ–∫ —Å –ø—Ä–æ–±–∫–æ–π

**–°—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**
‚Ä¢ üç∑ **–ú–æ–ª–æ–¥—ã–µ –≤–∏–Ω–∞** - 1-3 –≥–æ–¥–∞
‚Ä¢ üç∑ **–í—ã–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –≤–∏–Ω–∞** - 5-15 –ª–µ—Ç
‚Ä¢ üç∑ **–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –≤–∏–Ω–∞** - 20+ –ª–µ—Ç
‚Ä¢ ü•É **–ö—Ä–µ–ø–∫–∏–µ —Å–ø–∏—Ä—Ç—ã** - –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
‚Ä¢ üçπ **–ö–æ–∫—Ç–µ–π–ª–∏** - –ù–µ —Ö—Ä–∞–Ω—è—Ç—Å—è, –ø–æ–¥–∞—é—Ç—Å—è —Å—Ä–∞–∑—É
‚Ä¢ ü•§ **–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ** - 1-2 –¥–Ω—è –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ
‚Ä¢ üçµ **–ß–∞–π** - 2-3 –≥–æ–¥–∞ –≤ —Å—É—Ö–æ–º –º–µ—Å—Ç–µ
‚Ä¢ ‚òï **–ö–æ—Ñ–µ** - 6-12 –º–µ—Å—è—Ü–µ–≤ –≤ –≥–µ—Ä–º–µ—Ç–∏—á–Ω–æ–π —É–ø–∞–∫–æ–≤–∫–µ

**–ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è:**
‚Ä¢ üç∑ **–í–∏–Ω–æ** - 3-5 –¥–Ω–µ–π –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ
‚Ä¢ ü•É **–°–ø–∏—Ä—Ç—ã** - 6-12 –º–µ—Å—è—Ü–µ–≤
‚Ä¢ üç∫ **–ü–∏–≤–æ** - 1-2 –¥–Ω—è –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ
‚Ä¢ üçπ **–ö–æ–∫—Ç–µ–π–ª–∏** - –ù–µ —Ö—Ä–∞–Ω—è—Ç—Å—è
‚Ä¢ ü•§ **–õ–∏–º–æ–Ω–∞–¥—ã** - 1-2 –¥–Ω—è –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ

üí° *–°–æ–≤–µ—Ç:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞–∫—É—É–º–Ω—É—é –ø—Ä–æ–±–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–Ω–∞.`;
  }
  
  if (lowerQuestion.includes('–±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π') || lowerQuestion.includes('–ª–∏–º–æ–Ω–∞–¥') || lowerQuestion.includes('–º–∏–ª–∫—à–µ–π–∫')) {
    return `ü•§ *–û –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–∞—Ö*

**–í–∏–¥—ã –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤:**
‚Ä¢ üçã **–õ–∏–º–æ–Ω–∞–¥—ã** - –æ—Å–≤–µ–∂–∞—é—â–∏–µ –Ω–∞–ø–∏—Ç–∫–∏ —Å —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–º–∏
‚Ä¢ ü•õ **–ú–∏–ª–∫—à–µ–π–∫–∏** - –≥—É—Å—Ç—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ —Å –º–æ–ª–æ–∫–æ–º –∏ –º–æ—Ä–æ–∂–µ–Ω—ã–º
‚Ä¢ üßÉ **–°–æ–∫–∏** - –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —Ñ—Ä—É–∫—Ç–æ–≤—ã–µ –∏ –æ–≤–æ—â–Ω—ã–µ
‚Ä¢ ü•§ **–ì–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ** - —Å –≥–∞–∑–æ–º –∏ —Å–∏—Ä–æ–ø–∞–º–∏
‚Ä¢ üßã **–°–º—É–∑–∏** - –≥—É—Å—Ç—ã–µ —Ñ—Ä—É–∫—Ç–æ–≤—ã–µ –∫–æ–∫—Ç–µ–π–ª–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:**
‚Ä¢ üåø **–°–≤–µ–∂–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã** - —Ñ—Ä—É–∫—Ç—ã, —è–≥–æ–¥—ã, —Ç—Ä–∞–≤—ã
‚Ä¢ üßä **–õ–µ–¥** - –∫—É–±–∏–∫–∏, –¥—Ä–æ–±–ª–µ–Ω—ã–π, –ª–µ–¥—è–Ω–∞—è –∫—Ä–æ—à–∫–∞
‚Ä¢ üçØ **–ü–æ–¥—Å–ª–∞—Å—Ç–∏—Ç–µ–ª–∏** - —Å–∞—Ö–∞—Ä, –º–µ–¥, —Å–∏—Ä–æ–ø—ã
‚Ä¢ üåø **–£–∫—Ä–∞—à–µ–Ω–∏—è** - –º—è—Ç–∞, —Ñ—Ä—É–∫—Ç—ã, —è–≥–æ–¥—ã

**–ü–æ–¥–∞—á–∞:**
‚Ä¢ üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞** - 2-6¬∞C (–æ—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–µ)
‚Ä¢ ü•Ç **–ü–æ—Å—É–¥–∞** - –≤—ã—Å–æ–∫–∏–µ —Å—Ç–∞–∫–∞–Ω—ã, –±–æ–∫–∞–ª—ã
‚Ä¢ ‚è∞ **–í—Ä–µ–º—è** - –ø–æ–¥–∞–≤–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

üí° *–°–æ–≤–µ—Ç:* –ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏ –∏–¥–µ–∞–ª—å–Ω—ã –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –∏ —Å–ª—É—á–∞–µ–≤.`;
  }

  if (lowerQuestion.includes('—á–∞–π') || lowerQuestion.includes('–∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–µ')) {
    return `üçµ *–û —á–∞–µ –∏ –µ–≥–æ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–∏*

**–í–∏–¥—ã —á–∞—è:**
‚Ä¢ üçÉ **–ó–µ–ª–µ–Ω—ã–π** - –Ω–µ—Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –ª–µ–≥–∫–∏–π –≤–∫—É—Å
‚Ä¢ üçÇ **–ß–µ—Ä–Ω—ã–π** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –∫—Ä–µ–ø–∫–∏–π
‚Ä¢ üå∏ **–£–ª—É–Ω** - –ø–æ–ª—É—Ñ–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å—Ä–µ–¥–Ω–∏–π
‚Ä¢ üåø **–ë–µ–ª—ã–π** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π, –Ω–µ–∂–Ω—ã–π
‚Ä¢ üå∫ **–¢—Ä–∞–≤—è–Ω–æ–π** - –∏–∑ —Ç—Ä–∞–≤ –∏ —Ü–≤–µ—Ç–æ–≤
‚Ä¢ üçä **–§—Ä—É–∫—Ç–æ–≤—ã–π** - —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ñ—Ä—É–∫—Ç–æ–≤

**–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è:**
‚Ä¢ üçÉ **–ó–µ–ª–µ–Ω—ã–π —á–∞–π** - 70-80¬∞C
‚Ä¢ üçÇ **–ß–µ—Ä–Ω—ã–π —á–∞–π** - 95-100¬∞C
‚Ä¢ üå∏ **–£–ª—É–Ω** - 85-95¬∞C
‚Ä¢ üåø **–ë–µ–ª—ã–π —á–∞–π** - 65-75¬∞C
‚Ä¢ üå∫ **–¢—Ä–∞–≤—è–Ω–æ–π** - 95-100¬∞C

**–í—Ä–µ–º—è –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏—è:**
‚Ä¢ üçÉ **–ó–µ–ª–µ–Ω—ã–π** - 2-3 –º–∏–Ω—É—Ç—ã
‚Ä¢ üçÇ **–ß–µ—Ä–Ω—ã–π** - 3-5 –º–∏–Ω—É—Ç
‚Ä¢ üå∏ **–£–ª—É–Ω** - 3-4 –º–∏–Ω—É—Ç—ã
‚Ä¢ üåø **–ë–µ–ª—ã–π** - 2-3 –º–∏–Ω—É—Ç—ã

üí° *–°–æ–≤–µ—Ç:* –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∫—É—Å —á–∞—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—è–≥–∫—É—é –≤–æ–¥—É.`;
  }

  if (lowerQuestion.includes('–∫–æ—Ñ–µ') || lowerQuestion.includes('–∑–µ—Ä–Ω–∞')) {
    return `‚òï *–û –∫–æ—Ñ–µ –∏ –µ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏*

**–í–∏–¥—ã –∫–æ—Ñ–µ:**
‚Ä¢ üü§ **–ê—Ä–∞–±–∏–∫–∞** - –º—è–≥–∫–∏–π, –∞—Ä–æ–º–∞—Ç–Ω—ã–π, 60-70% –º–∏—Ä–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
‚Ä¢ üü´ **–†–æ–±—É—Å—Ç–∞** - –∫—Ä–µ–ø–∫–∏–π, –≥–æ—Ä—å–∫–∏–π, –≤—ã—Å–æ–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ—Ñ–µ–∏–Ω–∞
‚Ä¢ üü§ **–°–º–µ—Å–∏** - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤

**–°–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:**
‚Ä¢ ‚òï **–≠—Å–ø—Ä–µ—Å—Å–æ** - –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
‚Ä¢ ü´ñ **–§–∏–ª—å—Ç—Ä-–∫–æ—Ñ–µ** - –∫–∞–ø–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
‚Ä¢ ü•§ **–§—Ä–µ–Ω—á-–ø—Ä–µ—Å—Å** - –Ω–∞—Å—Ç–∞–∏–≤–∞–Ω–∏–µ –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º
‚Ä¢ üßä **–•–æ–ª–æ–¥–Ω—ã–π** - –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Å—Ç–∞–∏–≤–∞–Ω–∏–µ
‚Ä¢ ü•õ **–ö–∞–ø—É—á–∏–Ω–æ** - —Å –º–æ–ª–æ—á–Ω–æ–π –ø–µ–Ω–æ–π
‚Ä¢ ü•§ **–õ–∞—Ç—Ç–µ** - —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–æ–ª–æ–∫–∞

**–ü–æ–º–æ–ª:**
‚Ä¢ üî¥ **–¢–æ–Ω–∫–∏–π** - –¥–ª—è —ç—Å–ø—Ä–µ—Å—Å–æ
‚Ä¢ üü° **–°—Ä–µ–¥–Ω–∏–π** - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä-–∫–æ—Ñ–µ
‚Ä¢ üü¢ **–ö—Ä—É–ø–Ω—ã–π** - –¥–ª—è —Ñ—Ä–µ–Ω—á-–ø—Ä–µ—Å—Å–∞

**–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã:** 90-96¬∞C

üí° *–°–æ–≤–µ—Ç:* –°–≤–µ–∂–µ–º–æ–ª–æ—Ç—ã–µ –∑–µ—Ä–Ω–∞ –¥–∞—é—Ç –ª—É—á—à–∏–π –∞—Ä–æ–º–∞—Ç –∏ –≤–∫—É—Å.`;
  }

  if (lowerQuestion.includes('–±–ª—é–¥–∞') || lowerQuestion.includes('–µ–¥–∞') || lowerQuestion.includes('–∫—É—Ö–Ω—è') || lowerQuestion.includes('–≥–∞—Ä–Ω–∏—Ä')) {
    return `üçΩÔ∏è *–ü–æ–¥–±–æ—Ä –Ω–∞–ø–∏—Ç–∫–æ–≤ –∫ –±–ª—é–¥–∞–º*

**–ö –∫—Ä–∞—Å–Ω—ã–º –≤–∏–Ω–∞–º:**
‚Ä¢ ü•© –ú—è—Å–Ω—ã–µ –±–ª—é–¥–∞ (–≥–æ–≤—è–¥–∏–Ω–∞, –±–∞—Ä–∞–Ω–∏–Ω–∞, –¥–∏—á—å)
‚Ä¢ üßÄ –°—ã—Ä–Ω—ã–µ –±–ª—é–¥–∞
‚Ä¢ üçù –ü–∞—Å—Ç–∞ —Å –º—è—Å–Ω—ã–º–∏ —Å–æ—É—Å–∞–º–∏
‚Ä¢ üç´ –®–æ–∫–æ–ª–∞–¥–Ω—ã–µ –¥–µ—Å–µ—Ä—Ç—ã

**–ö –±–µ–ª—ã–º –≤–∏–Ω–∞–º:**
‚Ä¢ üêü –†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã
‚Ä¢ üçó –ü—Ç–∏—Ü–∞ (–∫—É—Ä–∏—Ü–∞, –∏–Ω–¥–µ–π–∫–∞)
‚Ä¢ ü•ó –õ–µ–≥–∫–∏–µ —Å–∞–ª–∞—Ç—ã
‚Ä¢ ü•õ –°–ª–∏–≤–æ—á–Ω—ã–µ —Å–æ—É—Å—ã

**–ö –∏–≥—Ä–∏—Å—Ç—ã–º –≤–∏–Ω–∞–º:**
‚Ä¢ ü•Ç –ê–ø–µ—Ä–∏—Ç–∏–≤—ã
‚Ä¢ ü•ó –õ–µ–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏
‚Ä¢ üßÄ –°—ã—Ä–Ω—ã–µ —Ç–∞—Ä–µ–ª–∫–∏
‚Ä¢ üç∞ –§—Ä—É–∫—Ç–æ–≤—ã–µ –¥–µ—Å–µ—Ä—Ç—ã

**–ö –∫—Ä–µ–ø–∫–∏–º —Å–ø–∏—Ä—Ç–∞–º:**
‚Ä¢ ü•É –ê–ø–µ—Ä–∏—Ç–∏–≤—ã
‚Ä¢ üßÄ –°—ã—Ä–Ω—ã–µ —Ç–∞—Ä–µ–ª–∫–∏
‚Ä¢ üç´ –®–æ–∫–æ–ª–∞–¥–Ω—ã–µ –¥–µ—Å–µ—Ä—Ç—ã
‚Ä¢ ü•ú –û—Ä–µ—Ö–∏ –∏ —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç—ã

**–ö –∫–æ–∫—Ç–µ–π–ª—è–º:**
‚Ä¢ üçπ –ê–ø–µ—Ä–∏—Ç–∏–≤—ã, –¥–µ—Å–µ—Ä—Ç—ã, –∑–∞–∫—É—Å–∫–∏
‚Ä¢ üç∞ –°–ª–∞–¥–∫–∏–µ –¥–µ—Å–µ—Ä—Ç—ã –∫ —Å–ª–∞–¥–∫–∏–º –∫–æ–∫—Ç–µ–π–ª—è–º
‚Ä¢ ü•© –ú—è—Å–Ω—ã–µ –±–ª—é–¥–∞ –∫ –∫—Ä–µ–ø–∫–∏–º –∫–æ–∫—Ç–µ–π–ª—è–º

**–ö –±–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–º:**
‚Ä¢ ü•§ –õ—é–±—ã–µ –±–ª—é–¥–∞, –ø–æ–¥—Ö–æ–¥—è—Ç –≤—Å–µ–º
‚Ä¢ üç∞ –î–µ—Å–µ—Ä—Ç—ã –∫ —Å–ª–∞–¥–∫–∏–º –Ω–∞–ø–∏—Ç–∫–∞–º
‚Ä¢ ü•ó –õ–µ–≥–∫–∏–µ –±–ª—é–¥–∞ –∫ –æ—Å–≤–µ–∂–∞—é—â–∏–º –Ω–∞–ø–∏—Ç–∫–∞–º

**–ö —á–∞—é:**
‚Ä¢ üçµ –í–æ—Å—Ç–æ—á–Ω–∞—è –∫—É—Ö–Ω—è, –¥–µ—Å–µ—Ä—Ç—ã
‚Ä¢ üç∞ –°–ª–∞–¥–∫–∏–µ –¥–µ—Å–µ—Ä—Ç—ã, –≤—ã–ø–µ—á–∫–∞
‚Ä¢ ü•ó –õ–µ–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏

**–ö –∫–æ—Ñ–µ:**
‚Ä¢ ‚òï –ó–∞–≤—Ç—Ä–∞–∫–∏, –¥–µ—Å–µ—Ä—Ç—ã
‚Ä¢ üç∞ –®–æ–∫–æ–ª–∞–¥–Ω—ã–µ –¥–µ—Å–µ—Ä—Ç—ã, –≤—ã–ø–µ—á–∫–∞
‚Ä¢ ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã

üí° *–°–æ–≤–µ—Ç:* –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –±–ª—é–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∞.`;
  }
  
  if (lowerQuestion.includes('–∏–≥—Ä–∏—Å—Ç–æ–µ') || lowerQuestion.includes('—à–∞–º–ø–∞–Ω—Å–∫–æ–µ') || lowerQuestion.includes('—Å–ø–∞—Ä–∫–ª–∏–Ω–≥')) {
    return `ü•Ç *–ò–≥—Ä–∏—Å—Ç—ã–µ –≤–∏–Ω–∞*

**–í–∏–¥—ã –∏–≥—Ä–∏—Å—Ç—ã—Ö –≤–∏–Ω:**
‚Ä¢ üçæ **–®–∞–º–ø–∞–Ω—Å–∫–æ–µ** - —Ç–æ–ª—å–∫–æ –∏–∑ —Ä–µ–≥–∏–æ–Ω–∞ –®–∞–º–ø–∞–Ω—å –≤–æ –§—Ä–∞–Ω—Ü–∏–∏
‚Ä¢ ü•Ç **–ö—Ä–µ–º–∞–Ω** - –∏–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ –§—Ä–∞–Ω—Ü–∏–∏
‚Ä¢ ü•Ç **–ü—Ä–æ—Å–µ–∫–∫–æ** - –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–µ –∏–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ
‚Ä¢ ü•Ç **–ö–∞–≤–∞** - –∏—Å–ø–∞–Ω—Å–∫–æ–µ –∏–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ
‚Ä¢ ü•Ç **–õ–∞–º–±—Ä—É—Å–∫–æ** - –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–µ –∫—Ä–∞—Å–Ω–æ–µ –∏–≥—Ä–∏—Å—Ç–æ–µ

**–ü–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é —Å–∞—Ö–∞—Ä–∞:**
‚Ä¢ ü•Ç **–ë—Ä—é—Ç –ù–∞—Ç—é—Ä** - –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∞—Ö–∞—Ä–∞
‚Ä¢ ü•Ç **–ë—Ä—é—Ç** - –æ—á–µ–Ω—å —Å—É—Ö–æ–µ (–¥–æ 6 –≥/–ª)
‚Ä¢ ü•Ç **–≠–∫—Å—Ç—Ä–∞ –ë—Ä—é—Ç** - —Å—É—Ö–æ–µ (6-12 –≥/–ª)
‚Ä¢ ü•Ç **–ë—Ä—é—Ç –ó–µ—Ä–æ** - –±–µ–∑ —Å–∞—Ö–∞—Ä–∞

**–ü–æ–¥–∞—á–∞:**
‚Ä¢ üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 6-8¬∞C
‚Ä¢ ü•Ç –ë–æ–∫–∞–ª—ã: —Ñ–ª–µ–π—Ç—ã –∏–ª–∏ —Ç—é–ª—å–ø–∞–Ω—ã
‚Ä¢ ‚ö° –û—Ç–∫—Ä—ã–≤–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ, –∏–∑–±–µ–≥–∞—è –±—Ä—ã–∑–≥

üí° *–°–æ–≤–µ—Ç:* –ò–≥—Ä–∏—Å—Ç–æ–µ –≤–∏–Ω–æ - –æ—Ç–ª–∏—á–Ω—ã–π –∞–ø–µ—Ä–∏—Ç–∏–≤!`;
  }

  // –û–±—â–∏–π –æ—Ç–≤–µ—Ç
  return `üç∑ *–Ø —ç–∫—Å–ø–µ—Ä—Ç-—Å–æ–º–µ–ª—å–µ! –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ:*

**–í–∏–¥—ã –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:**
‚Ä¢ üç∑ –í–∏–¥—ã –≤–∏–Ω –ø–æ —Å–∞—Ö–∞—Ä—É –∏ —Ä–µ–≥–∏–æ–Ω—É
‚Ä¢ ü•É –¢–∏–ø—ã –≤–∏—Å–∫–∏ –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ üç∫ –°–æ—Ä—Ç–∞ –ø–∏–≤–∞ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
‚Ä¢ üçØ –ö—Ä–µ–ø–∫–∏–µ —Å–ø–∏—Ä—Ç—ã –∏ –ª–∏–∫–µ—Ä—ã

**–ü–æ–¥–∞—á–∞ –∏ —Å–µ—Ä–≤–∏—Ä–æ–≤–∫–∞:**
‚Ä¢ üå°Ô∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏
‚Ä¢ ü•Ç –í—ã–±–æ—Ä –±–æ–∫–∞–ª–æ–≤
‚Ä¢ ‚è∞ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–¥–∞—á–µ

**–•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤—ã–¥–µ—Ä–∂–∫–∞:**
‚Ä¢ üè∫ –£—Å–ª–æ–≤–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚Ä¢ ‚è∞ –°—Ä–æ–∫–∏ –≥–æ–¥–Ω–æ—Å—Ç–∏
‚Ä¢ üåë –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–≤–µ—Ç–∞

**–°–æ—á–µ—Ç–∞–Ω–∏–µ —Å –±–ª—é–¥–∞–º–∏:**
‚Ä¢ üçΩÔ∏è –ü–æ–¥–±–æ—Ä –∫ —Ä–∞–∑–Ω—ã–º –±–ª—é–¥–∞–º
‚Ä¢ üßÄ –°—ã—Ä–Ω—ã–µ —Ç–∞—Ä–µ–ª–∫–∏
‚Ä¢ üç∞ –î–µ—Å–µ—Ä—Ç—ã

üí° *–ó–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∏ —è —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É! –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –≤ –±–æ—Ç–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤.*`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
export function getCacheStats() {
  const now = Date.now();
  const stats = {
    totalEntries: aiResponseCache.size,
    validEntries: 0,
    expiredEntries: 0,
    memoryUsage: 0
  };
  
  for (const [key, value] of aiResponseCache.entries()) {
    if (now - value.timestamp < CACHE_DURATION) {
      stats.validEntries++;
      stats.memoryUsage += key.length + value.response.length;
    } else {
      stats.expiredEntries++;
    }
  }
  
  return stats;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
export function clearCache() {
  const beforeSize = aiResponseCache.size;
  cleanupCache();
  const afterSize = aiResponseCache.size;
  
  return {
    cleared: beforeSize - afterSize,
    remaining: afterSize
  };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export function getPersonalizedRecommendations(userHistory = []) {
  const recommendations = [];
  
  // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const categoryPreferences = {};
  const questionTypes = {};
  
  userHistory.forEach(entry => {
    if (entry.category) {
      categoryPreferences[entry.category] = (categoryPreferences[entry.category] || 0) + 1;
    }
    if (entry.questionType) {
      questionTypes[entry.questionType] = (questionTypes[entry.questionType] || 0) + 1;
    }
  });
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—é–±–∏–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const topCategories = Object.entries(categoryPreferences)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 3)
    .map(([category]) => category);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤
  const topQuestionTypes = Object.entries(questionTypes)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 3)
    .map(([type]) => type);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  if (topCategories.length > 0) {
    recommendations.push({
      type: 'category',
      message: `üç∑ –Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç ${topCategories.join(', ')}. –ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ –æ–± —ç—Ç–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö!`,
      categories: topCategories
    });
  }
  
  if (topQuestionTypes.length > 0) {
    recommendations.push({
      type: 'question',
      message: `üí° –í—ã —á–∞—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç–µ –æ ${topQuestionTypes.join(', ')}. –ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`,
      questionTypes: topQuestionTypes
    });
  }
  
  return recommendations;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞
export function analyzeQuestionComplexity(question) {
  const complexity = {
    level: 'medium',
    score: 0,
    factors: []
  };
  
  const lowerQuestion = question.toLowerCase();
  
  // –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  if (lowerQuestion.includes('—á—Ç–æ —ç—Ç–æ') || lowerQuestion.includes('–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è') || lowerQuestion.includes('—á—Ç–æ —Ç–∞–∫–æ–µ')) {
    complexity.score += 1;
    complexity.factors.push('basic_definition');
  }
  
  // –°—Ä–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã
  if (lowerQuestion.includes('–∫–∞–∫ –ø–æ–¥–∞–≤–∞—Ç—å') || lowerQuestion.includes('—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞') || lowerQuestion.includes('–±–æ–∫–∞–ª')) {
    complexity.score += 2;
    complexity.factors.push('serving_guidelines');
  }
  
  // –°–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  if (lowerQuestion.includes('—Å–æ—á–µ—Ç–∞–Ω–∏–µ') || lowerQuestion.includes('–≥–∞—Ä–º–æ–Ω–∏—è') || lowerQuestion.includes('–≤—ã–¥–µ—Ä–∂–∫–∞') || lowerQuestion.includes('—Ä–µ–≥–∏–æ–Ω')) {
    complexity.score += 3;
    complexity.factors.push('advanced_knowledge');
  }
  
  // –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  if (lowerQuestion.includes('—Ç–µ—Ö–Ω–∏–∫–∞') || lowerQuestion.includes('–º–µ—Ç–æ–¥') || lowerQuestion.includes('–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ') || lowerQuestion.includes('—Ä–µ—Ü–µ–ø—Ç')) {
    complexity.score += 4;
    complexity.factors.push('expert_technique');
  }
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
  if (complexity.score <= 1) {
    complexity.level = 'easy';
  } else if (complexity.score <= 3) {
    complexity.level = 'medium';
  } else if (complexity.score <= 5) {
    complexity.level = 'hard';
  } else {
    complexity.level = 'expert';
  }
  
  return complexity;
}

// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ò–ò
export async function testAI(request, env) {
  try {
    const { question, userContext } = await request.json();
    
    if (!question) {
      return jsonResponse({
        error: 'Question is required'
      }, 400);
    }
    
    console.log('Testing AI with question:', question);
    console.log('User context:', userContext);
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞
    const complexity = analyzeQuestionComplexity(question);
    console.log('Question complexity:', complexity);
    
    const answer = await askCloudflareAI(question, env, userContext);
    
    return jsonResponse({
      success: true,
      question: question,
      answer: answer,
      complexity: complexity,
      cacheStats: getCacheStats()
    });
  } catch (error) {
    console.error('AI test error:', error);
    return jsonResponse({
      error: error.message
    }, 500);
  }
} 